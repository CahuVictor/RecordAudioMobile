<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>RecordAudioMobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0047ab" />

  <!-- Manifesto para o PWA -->
  <link rel="manifest" href="manifest.json" />

  <!-- √çcone de atalho (fallback) -->
  <link rel="icon" href="assets/icons/icon-192.png" sizes="192x192" type="image/png" />
  <link rel="apple-touch-icon" href="assets/icons/icon-512.png" />

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }

    input[type="file"] {
      font-size: 16px;
      margin-bottom: 10px;
    }

    button {
      font-size: 18px;
      padding: 12px 24px;
      margin: 10px auto;
      display: block;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      width: 80%;
      max-width: 300px;
    }

    #startBtn { background-color: green; color: white; }
    #stopBtn { background-color: red; color: white; }
    #sendEmailBtn { background-color: #0047ab; color: white; }

    #logs, #instrucoes, #infoDisplay {
      text-align: left;
      font-size: 16px;
      background-color: #f1f1f1;
      padding: 10px;
      border-radius: 6px;
      margin-top: 20px;
    }

    #downloads a {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>üéôÔ∏è RecordAudioMobile</h2>

  <input type="file" id="infoFile" accept=".txt" />
  <p><strong>‚ÑπÔ∏è Dica:</strong> Envie um arquivo `.txt` com 3 linhas: Informa√ß√£o 1, Informa√ß√£o 2, Informa√ß√£o 3.</p>

  <div id="infoDisplay">üìã Nenhuma informa√ß√£o carregada.</div>

  <button id="startBtn">‚ñ∂Ô∏è Iniciar Grava√ß√£o</button>
  <button id="stopBtn" disabled>‚èπÔ∏è Parar Grava√ß√£o</button>
  <button id="sendEmailBtn" disabled>üìß Enviar por E-mail</button>

  <p id="status">Status: aguardando...</p>
  <div id="downloads"></div>
  <div id="logs"><strong>Logs:</strong><br></div>

  <div id="instrucoes">
    <strong>‚ö†Ô∏è Se a grava√ß√£o n√£o iniciar:</strong>
    <ul>
      <li>No <strong>Android/Chrome</strong>: v√° em <em>Configura√ß√µes > Sites > Microfone</em> e libere o acesso.</li>
      <li>No <strong>iPhone/Safari</strong>: v√° em <em>Ajustes > Safari > Microfone</em> e permita o acesso ao site.</li>
    </ul>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let gravacaoURL = '';
    const infoKeys = ['info1', 'info2', 'info3'];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");
    const downloads = document.getElementById("downloads");
    const logs = document.getElementById("logs");
    const infoFile = document.getElementById("infoFile");
    const infoDisplay = document.getElementById("infoDisplay");
    const sendEmailBtn = document.getElementById("sendEmailBtn");

    function log(msg) {
      logs.innerHTML += `${new Date().toLocaleTimeString()} - ${msg}<br>`;
      logs.scrollTop = logs.scrollHeight;
    }

    function atualizarInfoNaTela() {
      const info1 = localStorage.getItem('info1') || '';
      const info2 = localStorage.getItem('info2') || '';
      const info3 = localStorage.getItem('info3') || '';

      if (info1 && info2 && info3) {
        infoDisplay.innerHTML = `
          <strong>Informa√ß√µes carregadas:</strong><br>
          1Ô∏è‚É£ ${info1}<br>
          2Ô∏è‚É£ ${info2}<br>
          3Ô∏è‚É£ ${info3}
        `;
      } else {
        infoDisplay.innerHTML = "üìã Nenhuma informa√ß√£o carregada.";
      }
    }

    infoFile.addEventListener('change', () => {
      const file = infoFile.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = () => {
        const lines = reader.result.trim().split('\n');
        if (lines.length >= 3) {
          localStorage.setItem('info1', lines[0].trim());
          localStorage.setItem('info2', lines[1].trim());
          localStorage.setItem('info3', lines[2].trim());
          log("üìÑ Informa√ß√µes carregadas do arquivo.");
          atualizarInfoNaTela();
        } else {
          alert("O arquivo precisa conter pelo menos 3 linhas.");
        }
      };
      reader.readAsText(file);
    });

    startBtn.onclick = async () => {
      log("üîç Verificando permiss√£o para microfone...");
      try {
        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
        if (permissionStatus.state === 'denied') {
          alert('üö´ Microfone bloqueado. Libere nas configura√ß√µes do navegador.');
          log('‚ùå Permiss√£o negada permanentemente.');
          return;
        }

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        log("‚úÖ Permiss√£o concedida.");

        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = event => {
          if (event.data.size > 0) audioChunks.push(event.data);
        };

        mediaRecorder.onstart = () => {
          status.textContent = "Status: gravando...";
          log("‚ñ∂Ô∏è Grava√ß√£o iniciada.");
        };

        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          gravacaoURL = URL.createObjectURL(blob);

          const now = new Date();
          const timestamp = now.toISOString().replace(/[:T]/g, '-').split('.')[0];
          const info1 = localStorage.getItem('info1') || 'seminfo1';
          const info2 = localStorage.getItem('info2') || 'seminfo2';
          const info3 = localStorage.getItem('info3') || 'seminfo3';

          const filename = `gravacao_${timestamp}_${info1}_${info2}_${info3}.webm`.replace(/\s+/g, "_");

          const a = document.createElement("a");
          a.href = gravacaoURL;
          a.download = filename;
          a.textContent = `üéß Baixar: ${filename}`;
          downloads.appendChild(a);

          status.textContent = "Status: grava√ß√£o encerrada.";
          log(`‚úÖ Grava√ß√£o encerrada. Arquivo: ${filename}`);
          sendEmailBtn.disabled = false;
        };

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (err) {
        log("‚ùå Erro ao acessar microfone: " + err.message);
        alert("Erro ao acessar o microfone. Verifique as permiss√µes.");
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };

    sendEmailBtn.onclick = () => {
      const info1 = localStorage.getItem('info1') || '';
      const info2 = localStorage.getItem('info2') || '';
      const info3 = localStorage.getItem('info3') || '';
      const subject = encodeURIComponent(`Grava√ß√£o de √°udio
