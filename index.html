<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gravador de √Åudio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }

    input[type="text"] {
      font-size: 18px;
      padding: 8px;
      width: 80%;
      max-width: 300px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      font-size: 20px;
      padding: 15px 30px;
      margin: 10px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      width: 80%;
      max-width: 300px;
    }

    #startBtn {
      background-color: green;
      color: white;
    }

    #stopBtn {
      background-color: red;
      color: white;
    }

    #logs {
      margin-top: 20px;
      text-align: left;
      font-size: 16px;
      background-color: #f1f1f1;
      padding: 10px;
      border-radius: 6px;
      max-height: 200px;
      overflow-y: auto;
    }

    #instrucoes {
      background-color: #fff8dc;
      padding: 10px;
      border-radius: 6px;
      text-align: left;
      margin-top: 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>üéôÔ∏è Gravador de √Åudio</h2>

  <p><strong>‚ÑπÔ∏è Aten√ß√£o:</strong> Ao clicar em "Iniciar Grava√ß√£o", permita o acesso ao microfone quando o navegador pedir.</p>

  <label for="username">Seu nome (opcional):</label><br>
  <input id="username" type="text" placeholder="Digite seu nome"><br>

  <button id="startBtn">‚ñ∂Ô∏è Iniciar Grava√ß√£o</button>
  <button id="stopBtn" disabled>‚èπÔ∏è Parar Grava√ß√£o</button>

  <p id="status">Status: aguardando...</p>
  <div id="downloads"></div>
  <div id="logs"><strong>Logs:</strong><br></div>

  <div id="instrucoes">
    <strong>‚ö†Ô∏è Se a grava√ß√£o n√£o iniciar:</strong>
    <ul>
      <li>No <strong>Android/Chrome</strong>: v√° em <em>Configura√ß√µes > Sites > Microfone</em> e libere o acesso.</li>
      <li>No <strong>iPhone/Safari</strong>: v√° em <em>Ajustes > Safari > Microfone</em> e permita o acesso ao site.</li>
    </ul>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];

    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const status = document.getElementById("status");
    const downloads = document.getElementById("downloads");
    const logs = document.getElementById("logs");

    function log(msg) {
      logs.innerHTML += `${new Date().toLocaleTimeString()} - ${msg}<br>`;
      logs.scrollTop = logs.scrollHeight;
    }

    startBtn.onclick = async () => {
      log("üîç Verificando permiss√£o para microfone...");

      try {
        const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
        log("üìã Estado da permiss√£o: " + permissionStatus.state);

        if (permissionStatus.state === 'denied') {
          alert('üö´ O microfone est√° bloqueado. V√° nas configura√ß√µes do navegador para liberar o acesso.');
          log('‚ùå Acesso ao microfone negado permanentemente.');
          return;
        }

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        log("‚úÖ Permiss√£o concedida. Microfone ativo.");

        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = event => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
            log("üé§ Pacote de √°udio capturado.");
          }
        };

        mediaRecorder.onstart = () => {
          status.textContent = "Status: gravando...";
          log("‚ñ∂Ô∏è Grava√ß√£o iniciada.");
        };

        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(audioBlob);

          // Gera timestamp e nome
          const now = new Date();
          const timestamp = now.toISOString().replace(/[:T]/g, '-').split('.')[0];
          const usernameInput = document.getElementById("username").value.trim();
          const sanitizedName = usernameInput ? usernameInput.toLowerCase().replace(/\s+/g, "_") : "sem_nome";
          const filename = `gravacao_${timestamp}_${sanitizedName}.webm`;

          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          a.textContent = `üéß Baixar: ${filename}`;
          a.style.display = "block";
          a.style.marginTop = "10px";
          downloads.appendChild(a);

          status.textContent = "Status: grava√ß√£o encerrada.";
          log(`‚úÖ Grava√ß√£o encerrada. Nome do arquivo: ${filename}`);
        };

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (err) {
        log("‚ùå Erro ao tentar acessar o microfone: " + err.message);
        alert("Erro ao acessar o microfone. Verifique se voc√™ deu permiss√£o ao navegador.");
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };
  </script>
</body>
</html>
